#' Estimate age and length at 5% and full (100%) vulnerability (total selectivity) and retention (landings selectivity)
#'
#' @param Vdata Vulnerability-at-age vector (total selectivity of landings and discards) with names indicating ages
#' @param retdata Retention-at-age vector (combined selectivity for landings) with names indicating ages
#' @param Linf Von Bertalanffy growth parameter length infinity
#' @param K Von Bertalanffy growth parameter K
#' @param t0 Von Bertalanffy growth parameter theoretical age at age zero
#' @param length_sc Scalar (multiplier) to convert length units. MSEtool examples seem to use cm whereas BAM uses mm.
#' @param V_scaleToMax Should vulnerability be rescaled to max vulnerability?
#' @param ret_scaleToMax Should retention be rescaled to max retention?
#' @keywords bam stock assessment fisheries MSEtool
#' @author Nikolai Klibansky
#' @export
#' @examples
#' \dontrun{
#'
#' }
vulnerability <- function(Vdata,retdata=NULL, Linf,K,t0,length_sc=1,
                          V_scaleToMax=FALSE,
                          ret_scaleToMax=FALSE){
  # Vulnerability
  age <- 0:max(as.numeric(names(Vdata)))

  if(min(as.numeric(names(Vdata)))>0){
    warning(paste("Minimum age Vdata > 0. Vdata extrapolated to age-0"))
    Vdata <- pmin(1,pmax(0,Hmisc::approxExtrap(
      x=as.numeric(names(Vdata)),y=Vdata,xout=age)$y))
    names(Vdata) <- paste(age)
  }

  if(V_scaleToMax){
  Vdata <- Vdata/max(Vdata) # Scaled as a proportion of maximum vulnerability
  }
  Vage <- Vdata

  age_pr <- seq(min(age),max(age),length=1000)
  V_pr <- approx(age,Vage,xout = age_pr)$y

  ageV_05 <- age_pr[which.min(abs(V_pr-0.05))] # age at 5% vulnerability
  ageV_100 <- age_pr[which.min(abs(V_pr-1.00))] # age at 100% vulnerability

  lenage <- bamExtras::vb_len(Linf=Linf, K=K, t0=t0, a=age)*length_sc
  len_pr <- bamExtras::vb_len(Linf=Linf, K=K, t0=t0, a=age_pr)*length_sc

  lenV_05 <- bamExtras::vb_len(Linf=Linf, K=K, t0=t0, a=ageV_05)*length_sc # Length at 5% vulnerability
  lenV_100 <- bamExtras::vb_len(Linf=Linf, K=K, t0=t0, a=ageV_100)*length_sc # Length at 100% vulnerability

  # Retention
  if(is.null(retdata)){
    lenret_05 <-  lenV_05
    lenret_100 <- lenV_100
  }else{
    if(min(as.numeric(names(retdata)))>0){
      warning(paste("Minimum age retdata > 0. retdata extrapolated to age-0"))
      retdata <- pmin(1,pmax(0,Hmisc::approxExtrap(
        x=as.numeric(names(retdata)),y=retdata,xout=age)$y))
      names(retdata) <- paste(age)

    }

    if(ret_scaleToMax){
    retdata <- retdata/max(retdata) # Scaled as a proportion of maximum retention
    }
    retage <- retdata

    age_pr <- seq(min(age),max(age),length=1000)
    ret_pr <- approx(age,retage,xout = age_pr)$y

    ageret_05 <- age_pr[which.min(abs(ret_pr-0.05))] # age at 5% landings selectivity
    ageret_100 <- age_pr[which.min(abs(ret_pr-1.00))] # age at 100% landings selectivity

    lenage <- bamExtras::vb_len(Linf=Linf*length_sc, K=K, t0=t0, a=age)
    len_pr <- bamExtras::vb_len(Linf=Linf*length_sc, K=K, t0=t0, a=age_pr)

    lenret_05 <- bamExtras::vb_len(Linf=Linf*length_sc, K=K, t0=t0, a=ageret_05) # Length at 5% landings selectivity
    lenret_100 <- bamExtras::vb_len(Linf=Linf*length_sc, K=K, t0=t0, a=ageret_100) # Length at 100% landings selectivity
  }
  return(list("Vdata"=Vdata,"retdata"=retdata,
              "L5"=lenV_05,"LFS"=lenV_100,"LR5"=lenret_05,"LFR"=lenret_100,
              "A5"=ageV_05,"AFS"=ageV_100,"AR5"=ageret_05,"AFR"=ageret_100))
}
